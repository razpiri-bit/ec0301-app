<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Carta Descriptiva EC0301 - Sistema Profesional</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- jsPDF para exportación PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <!-- SweetAlert2 para notificaciones -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Docx.js para exportar a Word -->
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { 
            --primary: #1E3A8A; 
            --accent: #FF6B35;
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --light: #F8FAFC;
            --border: #E5E7EB;
            --text: #1F2937;
            --muted: #6B7280;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid var(--accent);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem 0;
        }
        
        h1 {
            font-size: 1.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toolbar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e3a8a;
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin: 2rem 0;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-title {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .box {
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            background: var(--light);
            margin-top: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .box:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.1);
        }
        
        .box h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .doms {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }
        
        .dom {
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 600;
        }
        
        .dom:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .dom.active {
            border-color: var(--accent);
            background: linear-gradient(135deg, #FF6B35 0%, #F97316 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .verbo {
            display: inline-block;
            background: white;
            border: 2px solid var(--border);
            padding: 0.4rem 0.8rem;
            margin: 0.25rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .verbo:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: scale(1.05);
        }
        
        .time {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), #3B82F6);
            color: white;
            border-radius: 20px;
            padding: 0.35rem 0.75rem;
            font-weight: 700;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
        
        .mt-1 { margin-top: 0.75rem; }
        .muted { color: var(--muted); font-size: 0.9rem; margin-top: 0.5rem; }
        
        .preview-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            font-weight: 500;
        }
        
        .progress-bar {
            background: var(--border);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, var(--success), #10B981);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .validation-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
        }
        
        .validation-indicator.valid {
            border-left: 4px solid var(--success);
        }
        
        .validation-indicator.invalid {
            border-left: 4px solid var(--danger);
        }
        
        .help-tip {
            display: inline-block;
            background: var(--warning);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            cursor: help;
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .doms { grid-template-columns: repeat(2, 1fr); }
        }
        
        /* Animaciones adicionales */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>
                    <i class="fa-solid fa-file-alt" style="color: var(--accent);"></i> 
                    Carta Descriptiva EC0301
                </h1>
                <div class="toolbar">
                    <button class="btn btn-secondary" onclick="showHelp()">
                        <i class="fa-solid fa-question-circle"></i> Ayuda
                    </button>
                    <button class="btn btn-secondary" onclick="loadDraft()">
                        <i class="fa-solid fa-download"></i> Cargar
                    </button>
                    <button class="btn btn-primary" onclick="saveDraft()">
                        <i class="fa-solid fa-save"></i> Guardar
                    </button>
                    <button class="btn btn-success" onclick="validateForm()">
                        <i class="fa-solid fa-check-circle"></i> Validar
                    </button>
                    <button class="btn btn-warning" onclick="exportCarta('pdf')">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-warning" onclick="exportCarta('docx')">
                        <i class="fa-solid fa-file-word"></i> Word
                    </button>
                    <button class="btn btn-success pulse" onclick="markComplete()">
                        <i class="fa-solid fa-trophy"></i> Completar
                    </button>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sección 1: Información General -->
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-info-circle"></i> 
                1. Información General del Curso
            </h2>
            <div class="grid-2">
                <div>
                    <label for="cd_nombre">Nombre del Curso/Taller *</label>
                    <input id="cd_nombre" placeholder="Ej: Diseño de cursos de capacitación" required>
                </div>
                <div>
                    <label for="cd_duracion">Duración total (horas) *</label>
                    <input id="cd_duracion" type="number" placeholder="Ej: 40" min="1" max="200" required>
                </div>
                <div>
                    <label for="cd_diseñador">Nombre del diseñador instruccional *</label>
                    <input id="cd_diseñador" placeholder="Nombre completo" required>
                </div>
                <div>
                    <label for="cd_facilitador">Nombre del facilitador/instructor *</label>
                    <input id="cd_facilitador" placeholder="Nombre completo" required>
                </div>
                <div>
                    <label for="cd_lugar">Lugar de instrucción</label>
                    <input id="cd_lugar" placeholder="Dirección completa o modalidad virtual">
                </div>
                <div>
                    <label for="cd_fechas">Fechas de impartición</label>
                    <input id="cd_fechas" placeholder="Ej: 15-19 enero 2025">
                </div>
                <div>
                    <label for="cd_horario">Horario</label>
                    <input id="cd_horario" placeholder="Ej: 09:00-17:00">
                </div>
                <div>
                    <label for="cd_modalidad">Modalidad *</label>
                    <select id="cd_modalidad" required>
                        <option value="">Seleccione...</option>
                        <option value="presencial">Presencial</option>
                        <option value="virtual">Virtual</option>
                        <option value="hibrida">Híbrida</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Sección 2: Perfil del Participante -->
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-users"></i>
                2. Perfil del Participante
            </h2>
            <div class="grid-2">
                <div>
                    <label for="cd_psico">Características psicográficas *</label>
                    <textarea id="cd_psico" placeholder="Edad, ocupación, nivel educativo, experiencia previa..." required></textarea>
                </div>
                <div>
                    <label for="cd_conoc">Conocimientos previos requeridos *</label>
                    <textarea id="cd_conoc" placeholder="¿Qué debe saber el participante antes del curso?" required></textarea>
                </div>
                <div>
                    <label for="cd_hab">Habilidades previas requeridas</label>
                    <textarea id="cd_hab" placeholder="¿Qué debe saber hacer el participante?"></textarea>
                </div>
                <div>
                    <label for="cd_actitudes">Actitudes deseables</label>
                    <textarea id="cd_actitudes" placeholder="Disposición al aprendizaje, trabajo en equipo..."></textarea>
                </div>
                <div>
                    <label for="cd_num">Número de participantes *</label>
                    <input id="cd_num" placeholder="Ej: 10-20 personas" required>
                </div>
                <div>
                    <label for="cd_tipo">Tipo de grupo *</label>
                    <select id="cd_tipo" required>
                        <option value="">Seleccione...</option>
                        <option value="homogeneo">Homogéneo</option>
                        <option value="heterogeneo">Heterogéneo</option>
                        <option value="mixto">Mixto</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Sección 3: Objetivos -->
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-bullseye"></i>
                3. Objetivos de Aprendizaje
            </h2>
            
            <!-- Objetivo General -->
            <div class="box">
                <h3>
                    <i class="fa-solid fa-star"></i>
                    Objetivo General
                    <span class="help-tip" title="Debe cumplir criterios SMART">?</span>
                </h3>
                <div class="grid-2">
                    <div>
                        <label>Sujeto</label>
                        <input value="Al finalizar el curso, el participante" disabled style="background: var(--light);">
                    </div>
                    <div>
                        <label>Dominio principal *</label>
                        <select id="og_dom" required onchange="updateOG()">
                            <option value="">Seleccione dominio...</option>
                            <option value="cognitivo">Cognitivo (Conocimiento)</option>
                            <option value="psicomotriz">Psicomotriz (Habilidades)</option>
                            <option value="afectivo">Afectivo (Actitudes)</option>
                            <option value="relacional">Relacional-Social</option>
                        </select>
                    </div>
                </div>
                <div class="mt-1">
                    <label>Acción/Comportamiento observable *</label>
                    <textarea id="og_accion" placeholder="¿Qué podrá hacer el participante? Use verbos en futuro (será capaz de...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="mt-1">
                    <label>Condición de operación *</label>
                    <textarea id="og_cond" placeholder="¿En qué contexto o condiciones? ¿Con qué recursos?" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="mt-1">
                    <label>Criterio de evaluación *</label>
                    <textarea id="og_criterio" placeholder="¿Cómo se medirá el logro? ¿Qué nivel de desempeño?" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="preview-box">
                    <strong>Vista previa:</strong>
                    <div id="og_preview">Complete los campos para ver el objetivo...</div>
                </div>
            </div>

            <!-- Objetivos Particulares -->
            <div id="objetivosParticulares">
                <div class="box" data-op="1">
                    <h3>
                        <i class="fa-solid fa-tasks"></i>
                        Objetivo Particular 1
                    </h3>
                    <div class="doms">
                        <div class="dom active" data-op="1" data-d="cognitivo" onclick="selDom(1, 'cognitivo')">Cognitivo</div>
                        <div class="dom" data-op="1" data-d="psicomotriz" onclick="selDom(1, 'psicomotriz')">Psicomotriz</div>
                        <div class="dom" data-op="1" data-d="afectivo" onclick="selDom(1, 'afectivo')">Afectivo</div>
                        <div class="dom" data-op="1" data-d="relacional" onclick="selDom(1, 'relacional')">Relacional</div>
                    </div>
                    <div id="verbs1" style="margin: 0.75rem 0"></div>
                    <div class="grid-2">
                        <div>
                            <label>Verbo + Acción *</label>
                            <input id="op1_accion" placeholder="Ej: Identificará los elementos..." required>
                        </div>
                        <div>
                            <label>Condición/Contexto *</label>
                            <textarea id="op1_cond" placeholder="En qué condiciones..." required></textarea>
                        </div>
                    </div>
                    <div class="mt-1">
                        <label>Temas relacionados</label>
                        <textarea id="op1_temas" placeholder="Liste los temas que apoyan este objetivo (uno por línea)"></textarea>
                    </div>
                    <div class="mt-1">
                        <label>Tiempo estimado (minutos)</label>
                        <input type="number" id="op1_tiempo" placeholder="120" min="15">
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary mt-1" onclick="addObjetivoParticular()">
                <i class="fa-solid fa-plus"></i> Agregar Objetivo Particular
            </button>
        </div>

        <!-- Sección 4: Requerimientos -->
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-clipboard-list"></i>
                4. Requerimientos del Curso
            </h2>
            <div class="grid-2">
                <div>
                    <label>Instalaciones y mobiliario *</label>
                    <textarea id="rq_inst" placeholder="Aula con capacidad para X personas, mesas, sillas, ventilación..." required></textarea>
                </div>
                <div>
                    <label>Equipo tecnológico *</label>
                    <textarea id="rq_equipo" placeholder="Proyector, computadora, bocinas, pantalla..." required></textarea>
                </div>
                <div>
                    <label>Materiales didácticos *</label>
                    <textarea id="rq_mats" placeholder="Manuales, presentaciones, formatos de trabajo..." required></textarea>
                </div>
                <div>
                    <label>Recursos humanos</label>
                    <textarea id="rq_rh" placeholder="Instructor, co-facilitador, apoyo técnico..."></textarea>
                </div>
                <div>
                    <label>Consumibles</label>
                    <textarea id="rq_consumibles" placeholder="Plumas, hojas, post-its, marcadores..."></textarea>
                </div>
                <div>
                    <label>Otros requerimientos</label>
                    <textarea id="rq_otros" placeholder="Coffee break, estacionamiento, requisitos especiales..."></textarea>
                </div>
            </div>
        </div>

        <!-- Sección 5: Evaluación -->
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-chart-line"></i>
                5. Sistema de Evaluación
            </h2>
            
            <div class="box">
                <h3>Criterios generales</h3>
                <div class="grid-3">
                    <div>
                        <label>Calificación mínima aprobatoria *</label>
                        <select id="ev_min" required onchange="recalcEval()">
                            <option value="">Seleccione...</option>
                            <option value="70">70%</option>
                            <option value="80" selected>80%</option>
                            <option value="85">85%</option>
                            <option value="90">90%</option>
                        </select>
                    </div>
                    <div>
                        <label>Escala de calificación</label>
                        <select id="ev_escala">
                            <option value="0-100">0-100</option>
                            <option value="0-10">0-10</option>
                            <option value="NA-S">NA/S (No Acreditado/Suficiente)</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de certificación</label>
                        <select id="ev_cert">
                            <option value="constancia">Constancia de participación</option>
                            <option value="diploma">Diploma</option>
                            <option value="certificado">Certificado EC</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="box">
                <h3>Evaluación Diagnóstica <span class="time">Inicio</span></h3>
                <div class="grid-3">
                    <input id="ev_diag_mom" placeholder="Momento (ej: primeros 15 min)" value="Primeros 15 minutos">
                    <input id="ev_diag_ins" placeholder="Instrumento (ej: cuestionario)" value="Cuestionario de conocimientos previos">
                    <input id="ev_diag_prop" placeholder="Propósito" value="Identificar nivel inicial">
                </div>
            </div>
            
            <div class="box">
                <h3>Evaluación Formativa <span class="time">Durante</span></h3>
                <div class="grid-3">
                    <div>
                        <label>Ponderación (%)</label>
                        <select id="ev_form_pct" onchange="recalcEval()">
                            <option value="30">30%</option>
                            <option value="40" selected>40%</option>
                            <option value="50">50%</option>
                        </select>
                    </div>
                    <input id="ev_form_mom" placeholder="Momentos" value="Al finalizar cada tema">
                    <input id="ev_form_ins" placeholder="Instrumentos" value="Ejercicios prácticos, participación">
                </div>
            </div>
            
            <div class="box">
                <h3>Evaluación Sumativa <span class="time">Final</span></h3>
                <div class="grid-3">
                    <div>
                        <label>Ponderación (%)</label>
                        <input id="ev_sum_pct" placeholder="Calculado automático" disabled>
                    </div>
                    <input id="ev_sum_mom" placeholder="Momento" value="Última sesión">
                    <input id="ev_sum_ins" placeholder="Instrumentos" value="Examen teórico-práctico">
                </div>
            </div>
        </div>

        <!-- Sección 6: Desarrollo Cronológico -->
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-clock"></i>
                6. Desarrollo Cronológico del Curso
            </h2>
            
            <div class="box">
                <h3>Preparación previa <span class="time">30 min antes</span></h3>
                <textarea id="dc_prep" placeholder="Verificación de materiales, prueba de equipo, acomodo del aula, preparación de coffee break..."></textarea>
            </div>
            
            <div class="box">
                <h3>Encuadre <span class="time" id="encuadreTime">30 min</span></h3>
                <div class="grid-3">
                    <div>
                        <label>Presentación (min)</label>
                        <input type="number" id="dc_pres_t" value="10" min="5" onchange="recalcTimes()">
                    </div>
                    <div>
                        <label>Objetivos y programa (min)</label>
                        <input type="number" id="dc_obj_t" value="10" min="5" onchange="recalcTimes()">
                    </div>
                    <div>
                        <label>Reglas y evaluación (min)</label>
                        <input type="number" id="dc_reglas_t" value="10" min="5" onchange="recalcTimes()">
                    </div>
                </div>
                <div class="mt-1">
                    <label>Actividades de integración</label>
                    <textarea id="dc_integracion" placeholder="Dinámica rompehielo, presentación de participantes, expectativas..."></textarea>
                </div>
            </div>
            
            <div class="box">
                <h3>Desarrollo de contenidos <span class="time" id="desarrolloTime">Variable</span></h3>
                <div id="temasContainer">
                    <!-- Los temas se generarán dinámicamente -->
                </div>
                <button class="btn btn-primary mt-1" onclick="addTema()">
                    <i class="fa-solid fa-plus"></i> Agregar Tema
                </button>
            </div>
            
            <div class="box">
                <h3>Cierre <span class="time">20 min</span></h3>
                <textarea id="dc_cierre" placeholder="Resumen, verificación de objetivos, compromisos, evaluación de satisfacción, entrega de constancias..."></textarea>
            </div>
            
            <div class="box">
                <h3>Distribución del tiempo total</h3>
                <div class="grid-3">
                    <div>
                        <label>Encuadre</label>
                        <input id="sum_encuadre" disabled>
                    </div>
                    <div>
                        <label>Desarrollo</label>
                        <input id="sum_desarrollo" disabled>
                    </div>
                    <div>
                        <label>Total del curso</label>
                        <input id="sum_total" disabled style="font-weight: bold; color: var(--primary);">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicador de validación flotante -->
    <div class="validation-indicator invalid" id="validationIndicator" style="display: none;">
        <i class="fa-solid fa-exclamation-circle" style="color: var(--danger);"></i>
        <span>Documento incompleto</span>
    </div>

    <script>
    // ========== CONSTANTES Y CONFIGURACIÓN ==========
    const KEY = 'EC0301_CARTA_PRO';
    const VERBOS = {
        cognitivo: {
            conocimiento: ['Identificar', 'Reconocer', 'Listar', 'Nombrar', 'Definir', 'Describir'],
            comprension: ['Explicar', 'Interpretar', 'Resumir', 'Clasificar', 'Comparar', 'Ejemplificar'],
            aplicacion: ['Aplicar', 'Usar', 'Implementar', 'Ejecutar', 'Resolver', 'Demostrar'],
            analisis: ['Analizar', 'Diferenciar', 'Organizar', 'Relacionar', 'Examinar', 'Contrastar'],
            evaluacion: ['Evaluar', 'Criticar', 'Justificar', 'Argumentar', 'Validar', 'Decidir'],
            creacion: ['Crear', 'Diseñar', 'Construir', 'Planear', 'Producir', 'Desarrollar']
        },
        psicomotriz: {
            imitacion: ['Imitar', 'Copiar', 'Repetir', 'Reproducir', 'Seguir'],
            manipulacion: ['Manipular', 'Operar', 'Practicar', 'Ejecutar', 'Manejar'],
            precision: ['Demostrar', 'Completar', 'Mostrar', 'Calibrar', 'Controlar'],
            articulacion: ['Coordinar', 'Integrar', 'Adaptar', 'Modificar', 'Masterizar'],
            naturalizacion: ['Diseñar', 'Especificar', 'Gestionar', 'Inventar', 'Proyectar']
        },
        afectivo: {
            recepcion: ['Escuchar', 'Atender', 'Percibir', 'Recibir', 'Aceptar'],
            respuesta: ['Participar', 'Responder', 'Asistir', 'Practicar', 'Informar'],
            valoracion: ['Valorar', 'Apreciar', 'Justificar', 'Proponer', 'Compartir'],
            organizacion: ['Organizar', 'Integrar', 'Sintetizar', 'Priorizar', 'Combinar'],
            caracterizacion: ['Actuar', 'Discriminar', 'Influir', 'Modificar', 'Revisar']
        },
        relacional: {
            interaccion: ['Interactuar', 'Comunicar', 'Relacionar', 'Contactar', 'Dialogar'],
            colaboracion: ['Colaborar', 'Cooperar', 'Contribuir', 'Ayudar', 'Apoyar'],
            liderazgo: ['Liderar', 'Dirigir', 'Guiar', 'Motivar', 'Inspirar'],
            negociacion: ['Negociar', 'Mediar', 'Conciliar', 'Acordar', 'Resolver'],
            facilitacion: ['Facilitar', 'Moderar', 'Coordinar', 'Dinamizar', 'Gestionar']
        }
    };

    // ========== UTILIDADES ==========
    const $ = id => document.getElementById(id);
    
    let objetivosCount = 1;
    let temasCount = 0;

    // ========== FUNCIONES DE NOTIFICACIÓN ==========
    function toast(mensaje, tipo = 'success') {
        const iconos = {
            success: 'success',
            error: 'error',
            warning: 'warning',
            info: 'info'
        };
        
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: iconos[tipo] || 'info',
            title: mensaje,
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
    }

    // ========== FUNCIONES DE VERBOS ==========
    function renderVerbos(n, dominio = 'cognitivo') {
        const container = $(`verbs${n}`);
        if (!container) return;
        
        let html = '<div style="margin-bottom: 0.5rem;"><small>Verbos sugeridos (clic para usar):</small></div>';
        
        const categorias = VERBOS[dominio] || VERBOS.cognitivo;
        
        for (const [categoria, verbos] of Object.entries(categorias)) {
            html += `<div style="margin: 0.5rem 0;">
                <strong style="color: var(--primary); font-size: 0.8rem;">${categoria.charAt(0).toUpperCase() + categoria.slice(1)}:</strong>
                ${verbos.map(v => `<span class="verbo" onclick="insertVerbo(${n}, '${v}')">${v}</span>`).join('')}
            </div>`;
        }
        
        container.innerHTML = html;
    }

    function insertVerbo(n, verbo) {
        const input = $(`op${n}_accion`);
        if (!input) return;
        
        const textoActual = input.value.trim();
        if (textoActual && !textoActual.startsWith(verbo)) {
            // Reemplazar el primer verbo si existe
            input.value = verbo + ' ' + textoActual.replace(/^[A-ZÁÉÍÓÚÑa-záéíóúñ]+\s*/, '');
        } else {
            input.value = verbo + ' ';
        }
        input.focus();
        updateProgress();
    }

    function selDom(n, dominio) {
        // Actualizar clases activas
        document.querySelectorAll(`[data-op="${n}"] .dom`).forEach(d => {
            d.classList.remove('active');
        });
        document.querySelector(`[data-op="${n}"] .dom[data-d="${dominio}"]`)?.classList.add('active');
        
        // Renderizar nuevos verbos
        renderVerbos(n, dominio);
        updateProgress();
    }

    // ========== OBJETIVOS ==========
    function updateOG() {
        const sujeto = 'Al finalizar el curso, el participante';
        const accion = $('og_accion').value.trim();
        const condicion = $('og_cond').value.trim();
        const criterio = $('og_criterio').value.trim();
        
        let preview = sujeto;
        if (accion) preview += ' ' + accion;
        if (condicion) preview += ', ' + condicion;
        if (criterio) preview += ', ' + criterio;
        
        $('og_preview').innerHTML = preview + '.';
        updateProgress();
    }

    function addObjetivoParticular() {
        objetivosCount++;
        const container = $('objetivosParticulares');
        
        const newObj = document.createElement('div');
        newObj.className = 'box';
        newObj.setAttribute('data-op', objetivosCount);
        newObj.innerHTML = `
            <h3>
                <i class="fa-solid fa-tasks"></i>
                Objetivo Particular ${objetivosCount}
                <button class="btn btn-secondary" style="float: right; padding: 0.25rem 0.5rem;" 
                        onclick="removeObjetivo(${objetivosCount})">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </h3>
            <div class="doms">
                <div class="dom active" data-op="${objetivosCount}" data-d="cognitivo" 
                     onclick="selDom(${objetivosCount}, 'cognitivo')">Cognitivo</div>
                <div class="dom" data-op="${objetivosCount}" data-d="psicomotriz" 
                     onclick="selDom(${objetivosCount}, 'psicomotriz')">Psicomotriz</div>
                <div class="dom" data-op="${objetivosCount}" data-d="afectivo" 
                     onclick="selDom(${objetivosCount}, 'afectivo')">Afectivo</div>
                <div class="dom" data-op="${objetivosCount}" data-d="relacional" 
                     onclick="selDom(${objetivosCount}, 'relacional')">Relacional</div>
            </div>
            <div id="verbs${objetivosCount}" style="margin: 0.75rem 0"></div>
            <div class="grid-2">
                <div>
                    <label>Verbo + Acción *</label>
                    <input id="op${objetivosCount}_accion" placeholder="Ej: Aplicará las técnicas..." required>
                </div>
                <div>
                    <label>Condición/Contexto *</label>
                    <textarea id="op${objetivosCount}_cond" placeholder="En qué condiciones..." required></textarea>
                </div>
            </div>
            <div class="mt-1">
                <label>Temas relacionados</label>
                <textarea id="op${objetivosCount}_temas" placeholder="Liste los temas (uno por línea)"></textarea>
            </div>
            <div class="mt-1">
                <label>Tiempo estimado (minutos)</label>
                <input type="number" id="op${objetivosCount}_tiempo" placeholder="120" min="15" onchange="recalcTimes()">
            </div>
        `;
        
        container.appendChild(newObj);
        renderVerbos(objetivosCount, 'cognitivo');
        
        // Animación de entrada
        newObj.style.animation = 'slideUp 0.5s ease';
        
        toast('Objetivo particular agregado', 'success');
    }

    function removeObjetivo(n) {
        if (objetivosCount <= 1) {
            toast('Debe mantener al menos un objetivo particular', 'warning');
            return;
        }
        
        Swal.fire({
            title: '¿Eliminar objetivo?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.querySelector(`[data-op="${n}"]`).remove();
                objetivosCount--;
                toast('Objetivo eliminado', 'info');
                updateProgress();
            }
        });
    }

    // ========== TEMAS ==========
    function addTema() {
        temasCount++;
        const container = $('temasContainer');
        
        const tema = document.createElement('div');
        tema.className = 'box';
        tema.setAttribute('data-tema', temasCount);
        tema.innerHTML = `
            <h3>
                Tema ${temasCount}
                <button class="btn btn-secondary" style="float: right; padding: 0.25rem 0.5rem;" 
                        onclick="removeTema(${temasCount})">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </h3>
            <div class="grid-2">
                <div>
                    <label>Nombre del tema *</label>
                    <input id="tema${temasCount}_nombre" placeholder="Título del tema" required>
                </div>
                <div>
                    <label>Duración (minutos) *</label>
                    <input type="number" id="tema${temasCount}_duracion" placeholder="60" min="15" 
                           onchange="recalcTimes()" required>
                </div>
            </div>
            <div class="grid-3 mt-1">
                <div>
                    <label>Técnica didáctica</label>
                    <select id="tema${temasCount}_tecnica">
                        <option value="expositiva">Expositiva</option>
                        <option value="demostrativa">Demostrativa</option>
                        <option value="dialogo">Diálogo-discusión</option>
                        <option value="ejercicios">Ejercicios prácticos</option>
                        <option value="casos">Estudio de casos</option>
                        <option value="roleplay">Role playing</option>
                    </select>
                </div>
                <div>
                    <label>Materiales</label>
                    <input id="tema${temasCount}_materiales" placeholder="Presentación, manual...">
                </div>
                <div>
                    <label>Evaluación</label>
                    <input id="tema${temasCount}_evaluacion" placeholder="Ejercicio, participación...">
                </div>
            </div>
            <div class="mt-1">
                <label>Actividades de aprendizaje</label>
                <textarea id="tema${temasCount}_actividades" placeholder="Describa las actividades paso a paso..."></textarea>
            </div>
        `;
        
        container.appendChild(tema);
        tema.style.animation = 'slideUp 0.5s ease';
        
        recalcTimes();
        toast('Tema agregado', 'success');
    }

    function removeTema(n) {
        Swal.fire({
            title: '¿Eliminar tema?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.querySelector(`[data-tema="${n}"]`).remove();
                temasCount--;
                recalcTimes();
                toast('Tema eliminado', 'info');
            }
        });
    }

    // ========== CÁLCULOS ==========
    function recalcTimes() {
        // Calcular encuadre
        const pres = parseInt($('dc_pres_t').value) || 0;
        const obj = parseInt($('dc_obj_t').value) || 0;
        const reglas = parseInt($('dc_reglas_t').value) || 0;
        const encuadre = pres + obj + reglas;
        
        $('sum_encuadre').value = `${encuadre} minutos`;
        $('encuadreTime').textContent = `${encuadre} min`;
        
        // Calcular desarrollo (temas + objetivos particulares)
        let desarrollo = 0;
        
        // Sumar tiempos de objetivos particulares
        for (let i = 1; i <= objetivosCount; i++) {
            const tiempo = parseInt($(`op${i}_tiempo`)?.value) || 0;
            desarrollo += tiempo;
        }
        
        // Sumar tiempos de temas
        for (let i = 1; i <= temasCount; i++) {
            const tiempo = parseInt($(`tema${i}_duracion`)?.value) || 0;
            desarrollo += tiempo;
        }
        
        $('sum_desarrollo').value = `${desarrollo} minutos`;
        $('desarrolloTime').textContent = `${desarrollo} min`;
        
        // Calcular total (+ 20 min de cierre)
        const total = encuadre + desarrollo + 20;
        const horas = Math.floor(total / 60);
        const minutos = total % 60;
        $('sum_total').value = `${horas} horas ${minutos} minutos`;
        
        updateProgress();
    }

    function recalcEval() {
        const formPct = parseInt($('ev_form_pct').value) || 40;
        $('ev_sum_pct').value = (100 - formPct) + '%';
        updateProgress();
    }

    // ========== VALIDACIÓN Y PROGRESO ==========
    function updateProgress() {
        const campos = [
            'cd_nombre', 'cd_duracion', 'cd_diseñador', 'cd_facilitador',
            'cd_modalidad', 'cd_psico', 'cd_conoc', 'cd_num', 'cd_tipo',
            'og_dom', 'og_accion', 'og_cond', 'og_criterio',
            'op1_accion', 'op1_cond',
            'rq_inst', 'rq_equipo', 'rq_mats',
            'ev_min'
        ];
        
        let completados = 0;
        campos.forEach(id => {
            if ($(id)?.value?.trim()) completados++;
        });
        
        const porcentaje = Math.round((completados / campos.length) * 100);
        $('progressBar').style.width = porcentaje + '%';
        
        // Actualizar indicador de validación
        const indicator = $('validationIndicator');
        if (porcentaje >= 80) {
            indicator.className = 'validation-indicator valid';
            indicator.innerHTML = '<i class="fa-solid fa-check-circle" style="color: var(--success);"></i><span>Documento válido</span>';
        } else {
            indicator.className = 'validation-indicator invalid';
            indicator.innerHTML = `<i class="fa-solid fa-exclamation-circle" style="color: var(--danger);"></i><span>${porcentaje}% completado</span>`;
        }
        indicator.style.display = 'flex';
        
        return porcentaje;
    }

    function validateForm() {
        const porcentaje = updateProgress();
        
        if (porcentaje < 80) {
            Swal.fire({
                title: 'Validación',
                html: `
                    <p>El documento está <strong>${porcentaje}% completo</strong>.</p>
                    <p>Se requiere al menos 80% para considerarlo válido según EC0301.</p>
                    <div style="margin-top: 1rem; text-align: left;">
                        <strong>Campos pendientes:</strong>
                        <ul style="margin-top: 0.5rem;">
                            ${getCamposPendientes().map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `,
                icon: 'warning',
                confirmButtonText: 'Entendido'
            });
        } else {
            Swal.fire({
                title: '¡Documento válido!',
                text: 'La carta descriptiva cumple con los requisitos del EC0301',
                icon: 'success',
                confirmButtonText: 'Excelente'
            });
        }
    }

    function getCamposPendientes() {
        const campos = {
            'cd_nombre': 'Nombre del curso',
            'cd_duracion': 'Duración total',
            'cd_diseñador': 'Nombre del diseñador',
            'cd_facilitador': 'Nombre del facilitador',
            'cd_modalidad': 'Modalidad del curso',
            'cd_psico': 'Características psicográficas',
            'cd_conoc': 'Conocimientos previos',
            'cd_num': 'Número de participantes',
            'cd_tipo': 'Tipo de grupo',
            'og_dom': 'Dominio del objetivo general',
            'og_accion': 'Acción del objetivo general',
            'og_cond': 'Condición del objetivo general',
            'og_criterio': 'Criterio de evaluación',
            'op1_accion': 'Objetivo particular 1 - Acción',
            'op1_cond': 'Objetivo particular 1 - Condición',
            'rq_inst': 'Instalaciones requeridas',
            'rq_equipo': 'Equipo tecnológico',
            'rq_mats': 'Materiales didácticos',
            'ev_min': 'Calificación mínima'
        };
        
        const pendientes = [];
        for (const [id, nombre] of Object.entries(campos)) {
            if (!$(id)?.value?.trim()) {
                pendientes.push(nombre);
            }
        }
        
        return pendientes;
    }

    // ========== GUARDAR Y CARGAR ==========
    function collectData() {
        const data = {
            // Información general
            nombre: $('cd_nombre').value,
            duracion: $('cd_duracion').value,
            diseñador: $('cd_diseñador').value,
            facilitador: $('cd_facilitador').value,
            lugar: $('cd_lugar').value,
            fechas: $('cd_fechas').value,
            horario: $('cd_horario').value,
            modalidad: $('cd_modalidad').value,
            
            // Perfil
            psico: $('cd_psico').value,
            conoc: $('cd_conoc').value,
            hab: $('cd_hab').value,
            actitudes: $('cd_actitudes').value,
            num: $('cd_num').value,
            tipo: $('cd_tipo').value,
            
            // Objetivo general
            og: {
                dom: $('og_dom').value,
                accion: $('og_accion').value,
                cond: $('og_cond').value,
                criterio: $('og_criterio').value
            },
            
            // Objetivos particulares
            objetivos: [],
            
            // Requerimientos
            rq: {
                inst: $('rq_inst').value,
                equipo: $('rq_equipo').value,
                mats: $('rq_mats').value,
                rh: $('rq_rh').value,
                consumibles: $('rq_consumibles').value,
                otros: $('rq_otros').value
            },
            
            // Evaluación
            ev: {
                min: $('ev_min').value,
                escala: $('ev_escala').value,
                cert: $('ev_cert').value,
                diag: {
                    mom: $('ev_diag_mom').value,
                    ins: $('ev_diag_ins').value,
                    prop: $('ev_diag_prop').value
                },
                form: {
                    pct: $('ev_form_pct').value,
                    mom: $('ev_form_mom').value,
                    ins: $('ev_form_ins').value
                },
                sum: {
                    pct: $('ev_sum_pct').value,
                    mom: $('ev_sum_mom').value,
                    ins: $('ev_sum_ins').value
                }
            },
            
            // Desarrollo cronológico
            dc: {
                prep: $('dc_prep').value,
                pres_t: $('dc_pres_t').value,
                obj_t: $('dc_obj_t').value,
                reglas_t: $('dc_reglas_t').value,
                integracion: $('dc_integracion').value,
                cierre: $('dc_cierre').value
            },
            
            // Temas
            temas: [],
            
            // Metadatos
            objetivosCount: objetivosCount,
            temasCount: temasCount,
            fechaActualizacion: new Date().toISOString()
        };
        
        // Recolectar objetivos particulares
        for (let i = 1; i <= objetivosCount; i++) {
            if ($(`op${i}_accion`)) {
                data.objetivos.push({
                    num: i,
                    dom: document.querySelector(`[data-op="${i}"] .dom.active`)?.dataset.d || 'cognitivo',
                    accion: $(`op${i}_accion`).value,
                    cond: $(`op${i}_cond`).value,
                    temas: $(`op${i}_temas`).value,
                    tiempo: $(`op${i}_tiempo`)?.value || ''
                });
            }
        }
        
        // Recolectar temas
        for (let i = 1; i <= temasCount; i++) {
            if ($(`tema${i}_nombre`)) {
                data.temas.push({
                    num: i,
                    nombre: $(`tema${i}_nombre`).value,
                    duracion: $(`tema${i}_duracion`).value,
                    tecnica: $(`tema${i}_tecnica`).value,
                    materiales: $(`tema${i}_materiales`).value,
                    evaluacion: $(`tema${i}_evaluacion`).value,
                    actividades: $(`tema${i}_actividades`).value
                });
            }
        }
        
        return data;
    }

    function saveDraft() {
        const data = collectData();
        localStorage.setItem(KEY, JSON.stringify(data));
        toast('Carta descriptiva guardada', 'success');
        updateProgress();
    }

    function loadDraft() {
        try {
            const saved = localStorage.getItem(KEY);
            if (!saved) {
                toast('No hay borradores guardados', 'info');
                return;
            }
            
            const data = JSON.parse(saved);
            
            // Cargar información general
            $('cd_nombre').value = data.nombre || '';
            $('cd_duracion').value = data.duracion || '';
            $('cd_diseñador').value = data.diseñador || '';
            $('cd_facilitador').value = data.facilitador || '';
            $('cd_lugar').value = data.lugar || '';
            $('cd_fechas').value = data.fechas || '';
            $('cd_horario').value = data.horario || '';
            $('cd_modalidad').value = data.modalidad || '';
            
            // Cargar perfil
            $('cd_psico').value = data.psico || '';
            $('cd_conoc').value = data.conoc || '';
            $('cd_hab').value = data.hab || '';
            $('cd_actitudes').value = data.actitudes || '';
            $('cd_num').value = data.num || '';
            $('cd_tipo').value = data.tipo || '';
            
            // Cargar objetivo general
            if (data.og) {
                $('og_dom').value = data.og.dom || '';
                $('og_accion').value = data.og.accion || '';
                $('og_cond').value = data.og.cond || '';
                $('og_criterio').value = data.og.criterio || '';
                updateOG();
            }
            
            // Cargar requerimientos
            if (data.rq) {
                $('rq_inst').value = data.rq.inst || '';
                $('rq_equipo').value = data.rq.equipo || '';
                $('rq_mats').value = data.rq.mats || '';
                $('rq_rh').value = data.rq.rh || '';
                $('rq_consumibles').value = data.rq.consumibles || '';
                $('rq_otros').value = data.rq.otros || '';
            }
            
            // Cargar evaluación
            if (data.ev) {
                $('ev_min').value = data.ev.min || '';
                $('ev_escala').value = data.ev.escala || '0-100';
                $('ev_cert').value = data.ev.cert || 'constancia';
                if (data.ev.diag) {
                    $('ev_diag_mom').value = data.ev.diag.mom || '';
                    $('ev_diag_ins').value = data.ev.diag.ins || '';
                    $('ev_diag_prop').value = data.ev.diag.prop || '';
                }
                if (data.ev.form) {
                    $('ev_form_pct').value = data.ev.form.pct || '';
                    $('ev_form_mom').value = data.ev.form.mom || '';
                    $('ev_form_ins').value = data.ev.form.ins || '';
                }
                if (data.ev.sum) {
                    $('ev_sum_mom').value = data.ev.sum.mom || '';
                    $('ev_sum_ins').value = data.ev.sum.ins || '';
                }
            }
            
            // Cargar desarrollo cronológico
            if (data.dc) {
                $('dc_prep').value = data.dc.prep || '';
                $('dc_pres_t').value = data.dc.pres_t || '';
                $('dc_obj_t').value = data.dc.obj_t || '';
                $('dc_reglas_t').value = data.dc.reglas_t || '';
                $('dc_integracion').value = data.dc.integracion || '';
                $('dc_cierre').value = data.dc.cierre || '';
            }
            
            // Recrear objetivos particulares
            if (data.objetivos && data.objetivos.length > 0) {
                // Limpiar objetivos existentes
                $('objetivosParticulares').innerHTML = '';
                objetivosCount = 0;
                
                // Recrear cada objetivo
                data.objetivos.forEach(obj => {
                    addObjetivoParticular();
                    $(`op${obj.num}_accion`).value = obj.accion || '';
                    $(`op${obj.num}_cond`).value = obj.cond || '';
                    $(`op${obj.num}_temas`).value = obj.temas || '';
                    $(`op${obj.num}_tiempo`).value = obj.tiempo || '';
                    selDom(obj.num, obj.dom || 'cognitivo');
                });
            }
            
            // Recrear temas
            if (data.temas && data.temas.length > 0) {
                // Limpiar temas existentes
                $('temasContainer').innerHTML = '';
                temasCount = 0;
                
                // Recrear cada tema
                data.temas.forEach(tema => {
                    addTema();
                    $(`tema${tema.num}_nombre`).value = tema.nombre || '';
                    $(`tema${tema.num}_duracion`).value = tema.duracion || '';
                    $(`tema${tema.num}_tecnica`).value = tema.tecnica || '';
                    $(`tema${tema.num}_materiales`).value = tema.materiales || '';
                    $(`tema${tema.num}_evaluacion`).value = tema.evaluacion || '';
                    $(`tema${tema.num}_actividades`).value = tema.actividades || '';
                });
            }
            
            recalcTimes();
            recalcEval();
            updateProgress();
            
            toast('Carta descriptiva cargada correctamente', 'success');
        } catch (error) {
            console.error(error);
            toast('Error al cargar el borrador', 'error');
        }
    }

    // ========== EXPORTACIÓN ==========
    async function exportCarta(formato) {
        const data = collectData();
        
        if (updateProgress() < 80) {
            const result = await Swal.fire({
                title: 'Documento incompleto',
                text: '¿Desea exportar de todas formas?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, exportar',
                cancelButtonText: 'Cancelar'
            });
            
            if (!result.isConfirmed) return;
        }
        
        if (formato === 'pdf') {
            exportPDF(data);
        } else if (formato === 'docx') {
            exportDOCX(data);
        }
    }

    function exportPDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configuración de estilos
        doc.setFont("helvetica");
        
        // Título
        doc.setFontSize(20);
        doc.setTextColor(30, 58, 138);
        doc.text('CARTA DESCRIPTIVA EC0301', 105, 20, { align: 'center' });
        
        // Información general
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 53);
        doc.text('1. INFORMACIÓN GENERAL', 20, 35);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text(`Nombre del curso: ${data.nombre}`, 20, 45);
        doc.text(`Duración: ${data.duracion} horas`, 20, 52);
        doc.text(`Modalidad: ${data.modalidad}`, 20, 59);
        doc.text(`Diseñador: ${data.diseñador}`, 20, 66);
        doc.text(`Facilitador: ${data.facilitador}`, 20, 73);
        doc.text(`Lugar: ${data.lugar}`, 20, 80);
        doc.text(`Fechas: ${data.fechas}`, 20, 87);
        doc.text(`Horario: ${data.horario}`, 20, 94);
        
        // Perfil del participante
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 53);
        doc.text('2. PERFIL DEL PARTICIPANTE', 20, 108);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        const perfilY = 118;
        doc.text('Características psicográficas:', 20, perfilY);
        const psico = doc.splitTextToSize(data.psico || 'No especificado', 170);
        doc.text(psico, 20, perfilY + 7);
        
        // Objetivo general
        doc.addPage();
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 53);
        doc.text('3. OBJETIVOS', 20, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(30, 58, 138);
        doc.text('Objetivo General:', 20, 30);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        const objetivo = `Al finalizar el curso, el participante ${data.og.accion}, ${data.og.cond}, ${data.og.criterio}.`;
        const objLines = doc.splitTextToSize(objetivo, 170);
        doc.text(objLines, 20, 38);
        
        // Objetivos particulares
        let yPos = 55;
        doc.setFontSize(12);
        doc.setTextColor(30, 58, 138);
        doc.text('Objetivos Particulares:', 20, yPos);
        
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        data.objetivos.forEach((obj, index) => {
            yPos += 10;
            if (yPos > 270) {
                doc.addPage();
                yPos = 20;
            }
            doc.text(`${index + 1}. ${obj.accion}`, 20, yPos);
            if (obj.cond) {
                yPos += 7;
                const condLines = doc.splitTextToSize(`   Condición: ${obj.cond}`, 160);
                doc.text(condLines, 20, yPos);
                yPos += condLines.length * 5;
            }
        });
        
        // Evaluación
        doc.addPage();
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 53);
        doc.text('5. SISTEMA DE EVALUACIÓN', 20, 20);
        
        // Tabla de evaluación
        const evalData = [
            ['Tipo', 'Momento', 'Instrumento', 'Ponderación'],
            ['Diagnóstica', data.ev.diag.mom || 'Inicio', data.ev.diag.ins || 'Cuestionario', '0%'],
            ['Formativa', data.ev.form.mom || 'Durante', data.ev.form.ins || 'Ejercicios', data.ev.form.pct + '%' || '40%'],
            ['Sumativa', data.ev.sum.mom || 'Final', data.ev.sum.ins || 'Examen', data.ev.sum.pct || '60%']
        ];
        
        doc.autoTable({
            head: [evalData[0]],
            body: evalData.slice(1),
            startY: 30,
            theme: 'grid',
            headStyles: { fillColor: [30, 58, 138] }
        });
        
        // Desarrollo cronológico
        doc.addPage();
        doc.setFontSize(14);
        doc.setTextColor(255, 107, 53);
        doc.text('6. DESARROLLO CRONOLÓGICO', 20, 20);
        
        // Resumen de tiempos
        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);
        doc.text(`Encuadre: ${$('sum_encuadre').value}`, 20, 35);
        doc.text(`Desarrollo: ${$('sum_desarrollo').value}`, 20, 42);
        doc.text(`Cierre: 20 minutos`, 20, 49);
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL: ${$('sum_total').value}`, 20, 56);
        
        // Temas
        if (data.temas.length > 0) {
            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.setTextColor(30, 58, 138);
            doc.text('Temas del curso:', 20, 70);
            
            const temasData = [['#', 'Tema', 'Duración', 'Técnica']];
            data.temas.forEach((tema, index) => {
                temasData.push([
                    (index + 1).toString(),
                    tema.nombre || 'Sin nombre',
                    tema.duracion + ' min' || '0 min',
                    tema.tecnica || 'No especificada'
                ]);
            });
            
            doc.autoTable({
                head: [temasData[0]],
                body: temasData.slice(1),
                startY: 75,
                theme: 'striped',
                headStyles: { fillColor: [255, 107, 53] }
            });
        }
        
        // Pie de página en todas las páginas
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(10);
            doc.setTextColor(128, 128, 128);
            doc.text(`Página ${i} de ${pageCount}`, 105, 285, { align: 'center' });
            doc.text(`Generado: ${new Date().toLocaleDateString('es-MX')}`, 20, 285);
        }
        
        // Guardar PDF
        doc.save(`Carta_Descriptiva_${data.nombre || 'EC0301'}_${new Date().getTime()}.pdf`);
        toast('PDF generado exitosamente', 'success');
    }

    async function exportDOCX(data) {
        try {
            const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, Table, TableRow, TableCell, WidthType } = docx;
            
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: [
                        // Título principal
                        new Paragraph({
                            text: "CARTA DESCRIPTIVA EC0301",
                            heading: HeadingLevel.TITLE,
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 400 }
                        }),
                        
                        // Sección 1: Información General
                        new Paragraph({
                            text: "1. INFORMACIÓN GENERAL",
                            heading: HeadingLevel.HEADING_1,
                            spacing: { before: 200, after: 200 }
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Nombre del curso: ", bold: true }),
                                new TextRun(data.nombre || "No especificado")
                            ]
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Duración: ", bold: true }),
                                new TextRun(`${data.duracion || 0} horas`)
                            ]
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Modalidad: ", bold: true }),
                                new TextRun(data.modalidad || "No especificada")
                            ]
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Diseñador instruccional: ", bold: true }),
                                new TextRun(data.diseñador || "No especificado")
                            ]
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Facilitador: ", bold: true }),
                                new TextRun(data.facilitador || "No especificado")
                            ],
                            spacing: { after: 400 }
                        }),
                        
                        // Sección 2: Perfil del Participante
                        new Paragraph({
                            text: "2. PERFIL DEL PARTICIPANTE",
                            heading: HeadingLevel.HEADING_1,
                            spacing: { before: 200, after: 200 }
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Características psicográficas:\n", bold: true }),
                                new TextRun(data.psico || "No especificado")
                            ]
                        }),
                        
                        new Paragraph({
                            children: [
                                new TextRun({ text: "Conocimientos previos:\n", bold: true }),
                                new TextRun(data.conoc || "No especificado")
                            ],
                            spacing: { after: 400 }
                        }),
                        
                        // Sección 3: Objetivos
                        new Paragraph({
                            text: "3. OBJETIVOS DE APRENDIZAJE",
                            heading: HeadingLevel.HEADING_1,
                            spacing: { before: 200, after: 200 }
                        }),
                        
                        new Paragraph({
                            text: "Objetivo General:",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { after: 100 }
                        }),
                        
                        new Paragraph({
                            text: `Al finalizar el curso, el participante ${data.og.accion || ''}, ${data.og.cond || ''}, ${data.og.criterio || ''}.`,
                            spacing: { after: 200 }
                        }),
                        
                        new Paragraph({
                            text: "Objetivos Particulares:",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { after: 100 }
                        }),
                        
                        ...data.objetivos.map((obj, index) => 
                            new Paragraph({
                                text: `${index + 1}. ${obj.accion}`,
                                bullet: { level: 0 },
                                spacing: { after: 100 }
                            })
                        ),
                        
                        // Sección de Evaluación
                        new Paragraph({
                            text: "5. SISTEMA DE EVALUACIÓN",
                            heading: HeadingLevel.HEADING_1,
                            spacing: { before: 400, after: 200 }
                        }),
                        
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ text: "Tipo", bold: true })] }),
                                        new TableCell({ children: [new Paragraph({ text: "Momento", bold: true })] }),
                                        new TableCell({ children: [new Paragraph({ text: "Instrumento", bold: true })] }),
                                        new TableCell({ children: [new Paragraph({ text: "Ponderación", bold: true })] })
                                    ]
                                }),
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph("Diagnóstica")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.diag.mom || "Inicio")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.diag.ins || "Cuestionario")] }),
                                        new TableCell({ children: [new Paragraph("0%")] })
                                    ]
                                }),
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph("Formativa")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.form.mom || "Durante")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.form.ins || "Ejercicios")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.form.pct + "%")] })
                                    ]
                                }),
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph("Sumativa")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.sum.mom || "Final")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.sum.ins || "Examen")] }),
                                        new TableCell({ children: [new Paragraph(data.ev.sum.pct || "60%")] })
                                    ]
                                })
                            ]
                        })
                    ]
                }]
            });
            
            // Generar y descargar el documento
            const blob = await Packer.toBlob(doc);
            saveAs(blob, `Carta_Descriptiva_${data.nombre || 'EC0301'}_${new Date().getTime()}.docx`);
            
            toast('Documento Word generado exitosamente', 'success');
        } catch (error) {
            console.error('Error al generar DOCX:', error);
            toast('Error al generar el documento Word', 'error');
        }
    }

    // ========== AYUDA ==========
    function showHelp() {
        Swal.fire({
            title: 'Guía Rápida',
            html: `
                <div style="text-align: left;">
                    <h4 style="color: var(--primary);">📝 Carta Descriptiva EC0301</h4>
                    <p>Este formulario te ayuda a crear una carta descriptiva completa según el estándar EC0301.</p>
                    
                    <h5 style="margin-top: 1rem;">✅ Requisitos mínimos:</h5>
                    <ul>
                        <li>Información general del curso</li>
                        <li>Perfil del participante</li>
                        <li>Objetivo general (criterios SMART)</li>
                        <li>Al menos 1 objetivo particular</li>
                        <li>Requerimientos básicos</li>
                        <li>Sistema de evaluación</li>
                    </ul>
                    
                    <h5 style="margin-top: 1rem;">💡 Tips:</h5>
                    <ul>
                        <li>Usa los verbos sugeridos según el dominio</li>
                        <li>El objetivo general debe ser SMART</li>
                        <li>Guarda frecuentemente tu progreso</li>
                        <li>Valida antes de exportar</li>
                    </ul>
                    
                    <h5 style="margin-top: 1rem;">🎯 Dominios de aprendizaje:</h5>
                    <ul>
                        <li><strong>Cognitivo:</strong> Conocimientos y habilidades mentales</li>
                        <li><strong>Psicomotriz:</strong> Habilidades físicas y destrezas</li>
                        <li><strong>Afectivo:</strong> Actitudes y valores</li>
                        <li><strong>Relacional:</strong> Habilidades sociales</li>
                    </ul>
                </div>
            `,
            width: 600,
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#1E3A8A'
        });
    }

    // ========== COMPLETAR ==========
    async function markComplete() {
        const porcentaje = updateProgress();
        
        if (porcentaje < 80) {
            await Swal.fire({
                title: 'Documento incompleto',
                text: `El documento está ${porcentaje}% completo. Se requiere mínimo 80%.`,
                icon: 'warning',
                confirmButtonText: 'Entendido'
            });
            return;
        }
        
        const result = await Swal.fire({
            title: '¿Marcar como completado?',
            text: 'Esto indicará que la carta descriptiva está lista para revisión',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, completar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#22C55E'
        });
        
        if (result.isConfirmed) {
            saveDraft();
            
            // Enviar mensaje al sistema principal si está en iframe
            if (window.parent !== window) {
                window.parent.postMessage({
                    deliverable: 'carta-descriptiva',
                    progress: 100,
                    data: collectData()
                }, '*');
            }
            
            Swal.fire({
                title: '¡Completado!',
                text: 'La carta descriptiva ha sido marcada como completa',
                icon: 'success',
                confirmButtonText: 'Excelente'
            });
        }
    }

    // ========== INICIALIZACIÓN ==========
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar verbos para el primer objetivo
        renderVerbos(1, 'cognitivo');
        
        // Agregar algunos temas de ejemplo
        addTema();
        addTema();
        
        // Calcular tiempos iniciales
        recalcTimes();
        recalcEval();
        
        // Actualizar progreso inicial
        updateProgress();
        
        // Cargar borrador si existe
        if (localStorage.getItem(KEY)) {
            toast('Borrador disponible. Usa "Cargar" para recuperarlo', 'info');
        }
    });
    </script>
</body>
</html>}


